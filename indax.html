<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional URL Shortener</title>
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --primary: #3498db;
  --primary-dark: #2980b9;
  --secondary: #2ecc71;
  --secondary-dark: #27ae60;
  --danger: #e74c3c;
  --warning: #f39c12;
  --dark: #2c3e50;
  --light: #ecf0f1;
  --gray: #95a5a6;
  --light-gray: #bdc3c7;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #333;
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

header {
  background: var(--dark);
  color: white;
  padding: 25px;
  text-align: center;
}

header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

header p {
  color: var(--light);
  font-size: 1.1rem;
}

.content {
  display: flex;
  flex-wrap: wrap;
  min-height: 600px;
}

.section {
  flex: 1;
  min-width: 300px;
  padding: 30px;
}

.section-title {
  font-size: 1.8rem;
  color: var(--dark);
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light);
  display: flex;
  align-items: center;
}

.section-title i {
  margin-right: 10px;
  color: var(--primary);
}

.form-group {
  margin-bottom: 20px;
}

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--dark);
}

input, select {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid var(--light-gray);
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.btn {
  display: inline-block;
  background: var(--primary);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.btn-secondary {
  background: var(--secondary);
}

.btn-secondary:hover {
  background: var(--secondary-dark);
}

.btn-danger {
  background: var(--danger);
}

.result-box {
  margin-top: 25px;
  padding: 20px;
  background: var(--light);
  border-radius: 8px;
  border-left: 4px solid var(--primary);
}

.result-box h3 {
  margin-bottom: 10px;
  color: var(--dark);
}

.result-url {
  display: flex;
  align-items: center;
  margin-top: 10px;
}

.result-url a {
  color: var(--primary);
  font-weight: 600;
  text-decoration: none;
  word-break: break-all;
  flex: 1;
}

.result-url a:hover {
  text-decoration: underline;
}

.copy-btn {
  margin-left: 10px;
  background: var(--gray);
  padding: 8px 15px;
  font-size: 14px;
}

.analytics-controls {
  display: flex;
  gap: 15px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.analytics-controls select, .analytics-controls input {
  flex: 1;
  min-width: 150px;
}

.date-range {
  display: flex;
  gap: 10px;
}

.date-range input {
  min-width: 140px;
}

.stats-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.stat-card {
  background: white;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border-top: 4px solid var(--primary);
}

.stat-card:nth-child(2) {
  border-top-color: var(--secondary);
}

.stat-card:nth-child(3) {
  border-top-color: var(--warning);
}

.stat-card:nth-child(4) {
  border-top-color: var(--danger);
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--dark);
  margin: 10px 0;
}

.stat-label {
  color: var(--gray);
  font-size: 0.9rem;
}

.chart-container {
  background: white;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 25px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  height: 300px;
}

.links-table-container {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 15px;
  text-align: left;
  border-bottom: 1px solid var(--light);
}

th {
  background: var(--light);
  font-weight: 600;
  color: var(--dark);
}

tr:hover {
  background: rgba(52, 152, 219, 0.05);
}

.url-cell {
  max-width: 250px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.url-cell a {
  color: var(--primary);
  text-decoration: none;
}

.url-cell a:hover {
  text-decoration: underline;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--gray);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 15px;
  color: var(--light-gray);
}

.divider {
  width: 1px;
  background: var(--light);
  margin: 0 20px;
}

@media (max-width: 768px) {
  .content {
    flex-direction: column;
  }
  
  .divider {
    width: 100%;
    height: 1px;
    margin: 0;
  }
  
  .analytics-controls {
    flex-direction: column;
  }
  
  .date-range {
    flex-direction: column;
  }
  
  .stats-cards {
    grid-template-columns: 1fr 1fr;
  }
}

@media (max-width: 480px) {
  .stats-cards {
    grid-template-columns: 1fr;
  }
  
  .section {
    padding: 20px;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸ”— Professional URL Shortener</h1>
    <p>Create short links, track clicks, and analyze traffic</p>
  </header>
  
  <div class="content">
    <!-- URL Shortener Section -->
    <div class="section">
      <h2 class="section-title">URL Shortener</h2>
      
      <div class="form-group">
        <label for="longUrl">Destination URL</label>
        <input type="text" id="longUrl" placeholder="https://example.com/very-long-url">
      </div>
      
      <div class="form-group">
        <label for="customCode">Custom Short Code (Optional)</label>
        <input type="text" id="customCode" placeholder="my-custom-link">
      </div>
      
      <div class="form-group">
        <label for="linkTitle">Link Title (Optional)</label>
        <input type="text" id="linkTitle" placeholder="My Awesome Link">
      </div>
      
      <button id="shortenBtn" class="btn">Shorten URL</button>
      
      <div id="resultBox" class="result-box" style="display: none;">
        <h3>âœ… Your Short URL is Ready!</h3>
        <div class="result-url">
          <a id="shortUrl" href="#" target="_blank"></a>
          <button class="btn copy-btn" id="copyBtn">Copy</button>
        </div>
      </div>
    </div>
    
    <div class="divider"></div>
    
    <!-- Analytics Section -->
    <div class="section">
      <h2 class="section-title">Analytics Dashboard</h2>
      
      <div class="analytics-controls">
        <select id="timeFilter">
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="all">All Time</option>
          <option value="custom">Custom Range</option>
        </select>
        
        <div id="customDateRange" class="date-range" style="display: none;">
          <input type="date" id="startDate">
          <input type="date" id="endDate">
          <button id="applyDateRange" class="btn btn-secondary">Apply</button>
        </div>
        
        <button id="refreshAnalytics" class="btn btn-secondary">Refresh</button>
      </div>
      
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-label">Total URLs</div>
          <div class="stat-value" id="totalUrls">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Visits</div>
          <div class="stat-value" id="totalVisits">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Most Visited</div>
          <div class="stat-value" id="mostVisited">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Visitors</div>
          <div class="stat-value" id="uniqueVisitors">0</div>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="trafficChart"></canvas>
      </div>
      
      <div class="links-table-container">
        <table id="linksTable">
          <thead>
            <tr>
              <th>Short Code</th>
              <th>Title</th>
              <th>Long URL</th>
              <th>Visits</th>
              <th>Last Visit</th>
            </tr>
          </thead>
          <tbody id="linksTableBody">
            <!-- Table rows will be added here dynamically -->
          </tbody>
        </table>
        <div id="emptyTable" class="empty-state">
          <div>ðŸ“Š</div>
          <h3>No URLs Created Yet</h3>
          <p>Create your first shortened URL to see analytics here</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://urlshortener-d1814-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urlshortener-d1814",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// DOM elements
const longUrlInput = document.getElementById('longUrl');
const customCodeInput = document.getElementById('customCode');
const linkTitleInput = document.getElementById('linkTitle');
const shortenBtn = document.getElementById('shortenBtn');
const resultBox = document.getElementById('resultBox');
const shortUrlLink = document.getElementById('shortUrl');
const copyBtn = document.getElementById('copyBtn');
const timeFilter = document.getElementById('timeFilter');
const customDateRange = document.getElementById('customDateRange');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');
const applyDateRangeBtn = document.getElementById('applyDateRange');
const refreshAnalyticsBtn = document.getElementById('refreshAnalytics');
const linksTableBody = document.getElementById('linksTableBody');
const emptyTable = document.getElementById('emptyTable');
const totalUrlsElement = document.getElementById('totalUrls');
const totalVisitsElement = document.getElementById('totalVisits');
const mostVisitedElement = document.getElementById('mostVisited');
const uniqueVisitorsElement = document.getElementById('uniqueVisitors');

// Chart.js instance
let trafficChart = null;

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  // Set default dates for custom range
  const today = new Date();
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(today.getDate() - 7);
  
  startDateInput.valueAsDate = oneWeekAgo;
  endDateInput.valueAsDate = today;
  
  // Event listeners
  shortenBtn.addEventListener('click', shortenUrl);
  copyBtn.addEventListener('click', copyShortUrl);
  timeFilter.addEventListener('change', handleTimeFilterChange);
  applyDateRangeBtn.addEventListener('click', loadAnalytics);
  refreshAnalyticsBtn.addEventListener('click', loadAnalytics);
  
  // Check for redirect
  checkForRedirect();
  
  // Load initial analytics
  loadAnalytics();
});

// Generate random ID
function generateID(length = 5) {
  const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  return Array.from({length}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

// Shorten URL function
async function shortenUrl() {
  const longUrl = longUrlInput.value.trim();
  const customCode = customCodeInput.value.trim();
  const linkTitle = linkTitleInput.value.trim();
  
  if (!longUrl) {
    alert("Please enter a valid URL");
    return;
  }
  
  // Validate URL format
  try {
    new URL(longUrl);
  } catch (e) {
    alert("Please enter a valid URL format");
    return;
  }
  
  const code = customCode || generateID();
  
  // Check if custom code is already in use
  if (customCode) {
    try {
      const snapshot = await db.ref('links/' + code).once('value');
      if (snapshot.exists()) {
        alert("This custom code is already taken. Please choose a different one.");
        return;
      }
    } catch (error) {
      console.error("Error checking custom code:", error);
      alert("An error occurred while checking custom code availability");
      return;
    }
  }
  
  // Save to Firebase
  try {
    await db.ref('links/' + code).set({ 
      longUrl, 
      title: linkTitle || null,
      createdAt: new Date().toISOString(),
      visits: 0
    });
    
    // Show result
    const shortUrl = `${window.location.origin}?c=${code}`;
    shortUrlLink.textContent = shortUrl;
    shortUrlLink.href = shortUrl;
    resultBox.style.display = 'block';
    
    // Clear inputs
    longUrlInput.value = '';
    customCodeInput.value = '';
    linkTitleInput.value = '';
    
    // Reload analytics
    loadAnalytics();
  } catch (error) {
    console.error("Error saving URL:", error);
    alert("An error occurred while shortening the URL");
  }
}

// Copy short URL to clipboard
function copyShortUrl() {
  const url = shortUrlLink.href;
  navigator.clipboard.writeText(url).then(() => {
    // Visual feedback
    const originalText = copyBtn.textContent;
    copyBtn.textContent = 'Copied!';
    copyBtn.style.background = '#2ecc71';
    
    setTimeout(() => {
      copyBtn.textContent = originalText;
      copyBtn.style.background = '';
    }, 2000);
  });
}

// Handle time filter change
function handleTimeFilterChange() {
  if (timeFilter.value === 'custom') {
    customDateRange.style.display = 'flex';
  } else {
    customDateRange.style.display = 'none';
    loadAnalytics();
  }
}

// Get date range based on filter
function getDateRange() {
  const filter = timeFilter.value;
  const now = new Date();
  let startDate, endDate;
  
  switch(filter) {
    case 'today':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
      break;
    case 'week':
      const day = now.getDay();
      const diff = now.getDate() - day + (day === 0 ? -6 : 1);
      startDate = new Date(now.setDate(diff));
      startDate.setHours(0, 0, 0, 0);
      endDate = new Date();
      endDate.setHours(23, 59, 59, 999);
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
      break;
    case 'custom':
      const start = startDateInput.value;
      const end = endDateInput.value;
      if (start && end) {
        startDate = new Date(start);
        endDate = new Date(end);
        endDate.setHours(23, 59, 59, 999);
      } else {
        return { startDate: null, endDate: null };
      }
      break;
    default: // 'all'
      return { startDate: null, endDate: null };
  }
  
  return { startDate, endDate };
}

// Load analytics data
async function loadAnalytics() {
  try {
    // Get links data
    const linksSnapshot = await db.ref('links').once('value');
    const links = linksSnapshot.val() || {};
    
    // Get visits data
    const visitsSnapshot = await db.ref('visits').once('value');
    const visits = visitsSnapshot.val() || {};
    
    // Get date range for filtering
    const { startDate, endDate } = getDateRange();
    
    // Process data
    const linksData = {};
    let totalUrls = 0;
    let totalVisits = 0;
    let maxVisits = 0;
    let uniqueVisitors = new Set();
    
    // Initialize links data
    for (const code in links) {
      linksData[code] = {
        longUrl: links[code].longUrl,
        title: links[code].title || 'Untitled',
        total: 0,
        unique: new Set(),
        lastVisit: "N/A"
      };
      totalUrls++;
    }
    
    // Process visits
    for (const id in visits) {
      const visit = visits[id];
      const visitDate = new Date(visit.time);
      
      // Filter by date range if specified
      if (startDate && endDate) {
        if (visitDate < startDate || visitDate > endDate) {
          continue;
        }
      }
      
      if (linksData[visit.code]) {
        linksData[visit.code].total++;
        totalVisits++;
        
        // Track unique visitors
        if (visit.visitorId) {
          linksData[visit.code].unique.add(visit.visitorId);
          uniqueVisitors.add(visit.visitorId);
        }
        
        if (linksData[visit.code].total > maxVisits) {
          maxVisits = linksData[visit.code].total;
        }
        
        if (!linksData[visit.code].lastVisit || visitDate > new Date(linksData[visit.code].lastVisit)) {
          linksData[visit.code].lastVisit = visit.time;
        }
      }
    }
    
    // Update stats cards
    totalUrlsElement.textContent = totalUrls;
    totalVisitsElement.textContent = totalVisits;
    mostVisitedElement.textContent = maxVisits;
    uniqueVisitorsElement.textContent = uniqueVisitors.size;
    
    // Update table
    updateLinksTable(linksData);
    
    // Update chart
    updateTrafficChart(visits, startDate, endDate);
    
  } catch (error) {
    console.error("Error loading analytics:", error);
  }
}

// Update links table
function updateLinksTable(linksData) {
  linksTableBody.innerHTML = '';
  
  if (Object.keys(linksData).length === 0) {
    emptyTable.style.display = 'block';
    return;
  }
  
  emptyTable.style.display = 'none';
  
  for (const code in linksData) {
    const data = linksData[code];
    const lastVisit = data.lastVisit !== "N/A" 
      ? new Date(data.lastVisit).toLocaleDateString() 
      : "N/A";
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${code}</strong></td>
      <td>${data.title}</td>
      <td class="url-cell"><a href="?c=${code}" target="_blank">${data.longUrl}</a></td>
      <td>${data.total}</td>
      <td>${lastVisit}</td>
    `;
    linksTableBody.appendChild(row);
  }
}

// Update traffic chart
function updateTrafficChart(visits, startDate, endDate) {
  const ctx = document.getElementById('trafficChart').getContext('2d');
  
  // Destroy existing chart if it exists
  if (trafficChart) {
    trafficChart.destroy();
  }
  
  // Group visits by date
  const visitsByDate = {};
  
  for (const id in visits) {
    const visit = visits[id];
    const visitDate = new Date(visit.time);
    
    // Filter by date range if specified
    if (startDate && endDate) {
      if (visitDate < startDate || visitDate > endDate) {
        continue;
      }
    }
    
    const dateKey = visitDate.toISOString().split('T')[0]; // YYYY-MM-DD
    
    if (!visitsByDate[dateKey]) {
      visitsByDate[dateKey] = 0;
    }
    
    visitsByDate[dateKey]++;
  }
  
  // Sort dates and get recent ones
  const sortedDates = Object.keys(visitsByDate).sort();
  const recentDates = sortedDates.slice(-15); // Last 15 days
  
  const labels = recentDates.map(date => {
    const d = new Date(date);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });
  
  const data = recentDates.map(date => visitsByDate[date]);
  
  // Create chart
  trafficChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Daily Visits',
        data: data,
        borderColor: '#3498db',
        backgroundColor: 'rgba(52, 152, 219, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
}

// Check for redirect
function checkForRedirect() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("c");
  
  if (code) {
    db.ref('links/' + code).get().then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        
        // Record visit (excluding bots)
        const botPattern = /(bot|crawler|spider|curl|wget)/i;
        if (!botPattern.test(navigator.userAgent)) {
          // Generate a simple visitor ID
          const visitorId = Math.random().toString(36).substring(2) + Date.now().toString(36);
          
          db.ref('visits').push({ 
            code, 
            time: new Date().toISOString(), 
            ua: navigator.userAgent, 
            ref: document.referrer || "Direct",
            visitorId: visitorId
          });
          
          // Update visit count
          const updatedVisits = (data.visits || 0) + 1;
          db.ref('links/' + code).update({
            visits: updatedVisits
          });
        }
        
        // Redirect to the long URL
        window.location.href = data.longUrl;
      } else {
        alert("Link does not exist!");
      }
    });
  }
}
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</body>
</html>
